<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmail to Audio</title>
</head>

<body>
    {% if not messages %}
    <h1>Get emails!</h1>
    <form method="get" action="">
        <button type="submit" name="get_message_ids">Get Emails</button>
    </form>
    {% endif %}

    <!-- Display email list if available -->
    {% if message_ids %}
        <h2>Found some emails!</h2>

        {% for message_id in message_ids %}
        <div id="message-{{ message_id }}-container">
            <p>Message: {{ message_id }}</p>
            <div id="audio-player-{{ message_id }}"></div>
            <form method="get" action="" class="create-audio-form">
                <input type="hidden" name="message_id" value="{{ message_id }}">
                <button type="button" class="play-audio">Play</button>
                <button type="button" class="play-all-audios">Play all from here</button>
            </form>
        </div>
        {% endfor %}
    {% endif %}

    <script data-messages="{{ message_ids | safe }}">
        let currentIndex = 0;
        const data = document.currentScript.dataset;
        const messageIdsArrayString = data.messages;

        // Convert string to array
        let messageIdsArray = messageIdsArrayString
          .replace(/^\[|\]$/g, "")
          .split(/,\s*/)
          .map(id => id.replace(/^'|'$/g, ""));

        console.log("typeof messageIdsArrayArray", typeof messageIdsArray)
        let AutoplayIds = []

        function createAllAudios(firstMessageId) {
          AutoplayIds = []
          // Create an audio player for all messages starting from firstMessageId
          // console.log("messageIdsArray: ", messageIdsArray);
          // console.log("firstMessageId: ", firstMessageId);
          const startIndex = messageIdsArray.indexOf(firstMessageId);
          // console.log("startIndex: ", startIndex);
          // console.log("firstMessageId: ", firstMessageId);
          if (startIndex === -1) {
              console.error("Invalid messageId");
              return;
          }

          let endIndex = startIndex - 1;
          if (endIndex < 0) {
              endIndex = messageIdsArray.length - 1;
          }

          let iterationCount = 0;
          for (let i = startIndex; iterationCount < messageIdsArray.length; i = (i + 1) % messageIdsArray.length) {
            messageId = messageIdsArray[i]
            // console.log("messageIdsArray[" + i + "]:", messageIdsArray[i]); // Corrected logging statement
            const messageAudio = document.querySelector(`#message-${messageId}-container audio`);
            if (!messageAudio) {
              console.log("messageAudio is null for messageId: ", messageId);
              createAudio(messageId);
            }
            AutoplayIds.push(messageId);
            iterationCount++;
          }
          console.log("AutoplayIds: ", AutoplayIds);
          autoplayAudios(AutoplayIds);
      }

        function autoplayAudios(AutoplayIds) {
          let currentIndex = 0;

          function playNextAudio() {
            if (currentIndex >= AutoplayIds.length) {
              return; // All audios played
            }

            const currentId = AutoplayIds[currentIndex];
            const audioElement = document.querySelector(`#message-${currentId}-container audio`);

            if (audioElement) {
              audioElement.addEventListener('canplaythrough', function onCanPlayThrough() {
                audioElement.removeEventListener('canplaythrough', onCanPlayThrough); // Clean up the event listener
                audioElement.play();
              });

              audioElement.addEventListener('ended', function onAudioEnd() {
                audioElement.removeEventListener('ended', onAudioEnd); // Clean up the event listener
                currentIndex++;
                playNextAudio(); // Play the next audio
              });

              // Check if audio is already ready to play
              if (audioElement.readyState >= 4) {
                audioElement.play();
              }
            } else {
              console.error(`Audio element not found for message ID: ${currentId}`);
              currentIndex++;
              playNextAudio(); // Skip to the next audio if the current one is not found
            }
          }

        playNextAudio(); // Start playing the first audio
      }




        // Create an audio player for message
        function createAudio(messageId, autoplay = false) {
            fetch(`/audio?message_id=${messageId}`)
                .then(response => response.json())
                .then(data => {
                    let audioPlayer = document.createElement('audio');
                    audioPlayer.controls = true;
                    audioPlayer.src = data.audio_url;
                    // console.log("messageId: ", messageId);
                    document.querySelector(`#message-${messageId}-container`).appendChild(audioPlayer);
                    if (autoplay) {
                        audioPlayer.autoplay = true;
                    }
                })
                .catch(error => console.error('Error fetching audio:', error));

            };

            const playAudioButtons = document.querySelectorAll('.play-audio');
            playAudioButtons.forEach(button => {
                button.addEventListener('click', function () {
                    let form = this.parentElement;
                    let messageId = form.querySelector('input[name="message_id"]').value;
                    // console.log("messageId clicked: ", messageId);
                    createAudio(messageId, autoplay = true);
                });
            });

            const createAllAudioButtons = document.querySelectorAll('.play-all-audios');
            createAllAudioButtons.forEach(button => {
                button.addEventListener('click', function () {
                    let form = this.parentElement;
                    let messageId = form.querySelector('input[name="message_id"]').value;
                    // console.log("messageId in click: ", messageId);
                    // Create all audios starting from current message
                    createAllAudios(messageId);
                });
            });
    </script>
</body>

</html>