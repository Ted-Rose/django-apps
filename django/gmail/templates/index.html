<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmail to Audio</title>
</head>

<body>
    {% if not messages %}
    <h1>Get emails!</h1>
    <form method="get" action="">
        <button type="submit" name="get_message_ids">Get Emails</button>
    </form>
    {% endif %}

    <!-- Display email list if available -->
    {% if message_ids %}
        <h2>Found some emails!</h2>

        <form method="get" action="" id="read-all-emails-form">
            <button type="button" id="read-all-emails">Read all emails!</button>
        </form>

        {% for message_id in message_ids %}
            <p>Message: {{ message_id }}</p>
            <div id="audio-player-{{ message_id }}"></div>
            <form method="get" action="" class="create-audio-form">
                <input type="hidden" name="message_id" value="{{ message_id }}">
                <button type="button" class="create-audio-button">Create Audio</button>
            </form>
        {% endfor %}
    {% endif %}

    <script data-username="{{ message_ids }}">
        let currentIndex = 0;
        let audioUrls = [];
        const data = document.currentScript.dataset;
        const username = data.username;
        let messageIds = username
        console.log("messageIds: ", messageIds);

        document.getElementById('read-all-emails').addEventListener('click', function () {
            console.log("Clicked button!")
            fetchAllAudios();
        });

        function fetchAllAudios() {
            if (currentIndex <  messageIds | length ) {
                let messageId = document.getElementsByName('message_id')[currentIndex].value;
                fetch(`/audio?message_id=${messageId}`)
                    .then(response => response.json())
                    .then(data => {
                        audioUrls.push(data.audio_url);
                        playAudio(data.audio_url, messageId);
                        currentIndex++;
                        fetchAllAudios();
                    })
                    .catch(error => console.error('Error fetching audio:', error));
            }
        }

        function playAudio(audioUrl, messageId) {
            let audioPlayer = document.createElement('audio');
            audioPlayer.controls = true;
            audioPlayer.src = audioUrl;
            document.querySelector(`#audio-player-${messageId}`).appendChild(audioPlayer);
        };

        const createAudioButtons = document.querySelectorAll('.create-audio-button');
        createAudioButtons.forEach(button => {
            button.addEventListener('click', function () {
                let form = this.parentElement;
                let messageId = form.querySelector('input[name="message_id"]').value;
                fetch(`/audio?message_id=${messageId}`)
                    .then(response => response.json())
                    .then(data => {
                        audioUrls.push(data.audio_url);
                        playAudio(data.audio_url);
                    })
                    .catch(error => console.error('Error fetching audio:', error));
            });
        });
    </script>
</body>

</html>