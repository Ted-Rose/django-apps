<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmail to Audio</title>
</head>

<body>
    {% if not messages %}
    <h1>Get emails!</h1>
    <form method="get" action="">
      <label for="query">Filter what emails you would like to fetch:</label>
      <input type="text" id="query" name="query" value="is: unread">
      <button type="submit" name="get_messages">Get Emails</button>
  </form>
    {% endif %}

    <!-- Display email list if available -->
    {% if messages %}
        <h2>Found some emails!</h2>

        {% for message in messages %}
        <div id="message-{{ message.id }}-container">
            <p>Message id: {{ message.id }}</p>
            <p>Subject: {{ message.subject }}</p>
            <p>Sender: {{ message.sender }}</p>
            <p>Body: {{ message.body }}</p>
            <div id="audio-player-{{ message.id }}"></div>
            <form method="get" action="" class="create-audio-form">
                <input type="hidden" name="message_id" value="{{ message.id }}">
                <button type="button" class="play-audio">Play</button>
                <button type="button" class="play-all-audios">Play all from here</button>
            </form>
        </div>
        {% endfor %}
    {% endif %}

    <script data-messages="{{ messages | safe }}">
        let currentIndex = 0;
        const data = document.currentScript.dataset;
        const messagesArrayString = data.messages;
        
        // Convert string to array
        let messagesArray = JSON.parse(messagesArrayString.replace(/'/g, '"'));
        
        let AutoplayIds = []


        function createAllAudios(firstMessageId, playOnlyFirst = false) {
          AutoplayIds = [];
          const startIndex = messagesArray.findIndex(message => message.id === firstMessageId);

          if (startIndex === -1) {
              console.error("Invalid messageId");
              return;
          }

          let endIndex = startIndex - 1;
          if (endIndex < 0) {
              endIndex = messagesArray.length - 1;
          }

          let iterationCount = 0;
          for (
            let i = startIndex;
            iterationCount < messagesArray.length;
            i = (i + 1) % messagesArray.length) {
              messageId = messagesArray[i]['id']
              const messageAudio = document.querySelector(`#message-${messageId}-container audio`);
              if (!messageAudio) {
                console.log("Creating audio for messageId: ", messageId);
                messageString = 
                  "Subject: "
                  + messagesArray[i]['subject']
                  + "\n" + "Body: "
                  + messagesArray[i]['body'];
                createAudio(messageString, messageId);
              }
              AutoplayIds.push(messagesArray[i]['id']);
              iterationCount++;
          }
          autoplayAudios(AutoplayIds, playOnlyFirst);
      }


      function autoplayAudios(AutoplayIds, playOnlyFirst) {
        let currentIndex = 0;

        function waitForAudioElement(currentId, callback) {
          const interval = setInterval(() => {
            const audioElement = document.querySelector(`#message-${currentId}-container audio`);
            if (audioElement) {
              clearInterval(interval);
              callback(audioElement);
            }
          }, 100); // Check every 100ms
        }

        function playNextAudio(playOnlyFirst = null) {
          playableAudiosCount = messagesArray.length;
          if (playOnlyFirst) {
            playableAudiosCount = 1
          }

          if (currentIndex >= playableAudiosCount) {
            return; // All audios played
          }

          const currentId = AutoplayIds[currentIndex];
          waitForAudioElement(currentId, (audioElement) => {
            audioElement.addEventListener('loadeddata', function onLoadedData() {
              audioElement.removeEventListener('loadeddata', onLoadedData); // Clean up the event listener
              audioElement.play();
            });

            audioElement.addEventListener('ended', function onAudioEnd() {
              audioElement.removeEventListener('ended', onAudioEnd); // Clean up the event listener
              currentIndex++;
              if (!playOnlyFirst) {
                playNextAudio(); // Play the next audio
              }
            });

            // Check if audio is already ready to play
            if (audioElement.readyState >= 3) {
              audioElement.play();
            }
          });
        }

        playNextAudio(playOnlyFirst); // Start playing the first audio
      }


      // Create an audio player for message
      function createAudio(text, messageId, autoplay = false) {
          fetch(`/audio?text=${text}&filename=${messageId}`)
              .then(response => response.json())
              .then(data => {
                  let audioPlayer = document.createElement('audio');
                  audioPlayer.controls = true;
                  audioPlayer.src = data.audio_url;
                  document.querySelector(`#message-${messageId}-container`).appendChild(audioPlayer);
                  if (autoplay) {
                      audioPlayer.autoplay = true;
                  }
              })
              .catch(error => console.error('Error fetching audio:', error));

          };

      const playAudioButtons = document.querySelectorAll('.play-audio');
      playAudioButtons.forEach(button => {
          button.addEventListener('click', function () {
              let form = this.parentElement;
              let messageId = form.querySelector('input[name="message_id"]').value;
              createAllAudios(messageId, playOnlyCurrent = true);
          });
      });

      const createAllAudioButtons = document.querySelectorAll('.play-all-audios');
      createAllAudioButtons.forEach(button => {
          button.addEventListener('click', function () {
              let form = this.parentElement;
              let messageId = form.querySelector('input[name="message_id"]').value;
              // Create all audios starting from current message
              createAllAudios(messageId);
          });
      });
    </script>
</body>

</html>