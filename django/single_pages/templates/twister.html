<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twister!</title>
</head>
<body>
  <h1>Spēlējam Twister!</h1>
  
  <form id="arrays-form">
    <div id="base-array-container">
      <label for="base-array-0">Spelētāji</label>
      <div id="base-array-0">
        <input type="text" name="base-array" value="Kārlis">
      </div>
      <button type="button" onclick="addField('base-array-container', 'base-array')">Pievienot lauku</button>
    </div>
    
    <div id="sub-array-1-container">
      <label for="sub-array-1-0">Dzīvnieku lauki</label>
      <div id="sub-array-1-0">
        <input type="text" name="sub-array-1" value="Lauva">
      </div>
      <button type="button" onclick="addField('sub-array-1-container', 'sub-array-1')">Pievienot lauku</button>
    </div>
    
    <div id="sub-array-2-container">
      <label for="sub-array-2-0">Krāsu lauki</label>
      <div id="sub-array-2-0">
        <input type="text" name="sub-array-2" value="Sarkanais lauciņš">
      </div>
      <button type="button" onclick="addField('sub-array-2-container', 'sub-array-2')">Pievienot lauku</button>
    </div>
    
    <button type="button" id="create_game" onclick="createGame()">Spēlēt!</button>
  </form>
  
  <input type="checkbox" id="Pause" name="Pause" value="Pauze"> Pause
  
  <script>
    let moveLog = [];

    // Function to add a new input field
    function addField(containerId, arrayName) {
      const container = document.getElementById(containerId);
      const inputCount = container.getElementsByTagName('div').length;
      const newDiv = document.createElement('div');
      newDiv.id = `${arrayName}-${inputCount}`;
      const newField = document.createElement('input');
      newField.type = 'text';
      newField.name = arrayName;
      newDiv.appendChild(newField);
      container.appendChild(newDiv);
    }

    // Function to create audio element
    function createAudio(text, array, indexInArray) {
      const filename = hashOf(text);
      fetch(`/text-to-audio?text=${encodeURIComponent(text)}&filename=${filename}`)
        .then(response => response.json())
        .then(data => {
          const audioPlayer = document.createElement('audio');
          audioPlayer.controls = true;
          audioPlayer.src = data.audio_url;
          const targetDiv = document.getElementById(`${array}-${indexInArray}`);
          if (targetDiv) {
            targetDiv.appendChild(audioPlayer);
          } else {
            console.error(`Target element #${array}-${indexInArray} not found`);
          }
        })
        .catch(error => console.error('Error fetching audio:', error));
    }

    // Function to play audios
    async function playAudios(stringArray) {
      for (const string of stringArray) {
        const filename = hashOf(string);
        const audioElement = document.getElementById(filename);
        if (audioElement) {
          await new Promise((resolve) => {
            audioElement.onended = resolve;
            audioElement.play();
          });
        } else {
          console.error(`Audio element #${filename} not found`);
        }
      }
    }

    // Function to play the game
    function playGame(players, subArrays, index = 0) {
      const basePlayer = players[index % players.length];
      const randomSubArray1 = subArrays[0][Math.floor(Math.random() * subArrays[0].length)];
      const randomSubArray2 = subArrays[1][Math.floor(Math.random() * subArrays[1].length)];

      const nextMove = [basePlayer, randomSubArray1, randomSubArray2];
      playAudios(nextMove).then(() => {
        if (!document.getElementById('Pause').checked) {
          setTimeout(() => playGame(players, subArrays, index + 1), 5000);
        }
      });
    }

    // Function to create the game
    function createGame() {
      const players = Array.from(document.querySelectorAll('#base-array-container input')).map(input => input.value);
      const subArray1 = Array.from(document.querySelectorAll('#sub-array-1-container input')).map(input => input.value);
      const subArray2 = Array.from(document.querySelectorAll('#sub-array-2-container input')).map(input => input.value);

      // Create audio elements for the first move
      createAudio(players[0], 'base-array', 0);
      createAudio(subArray1[0], 'sub-array-1', 0);
      createAudio(subArray2[0], 'sub-array-2', 0);

      // Store the arrays
      moveLog = [[players[0], subArray1[0], subArray2[0]]];
      playGame(players, [subArray1, subArray2], 1);

      // Create audio elements for all moves
      players.forEach((player, i) => createAudio(player, 'base-array', i));
      subArray1.forEach((move, i) => createAudio(move, 'sub-array-1', i));
      subArray2.forEach((move, i) => createAudio(move, 'sub-array-2', i));
    }

    // Hash function (placeholder)
    function hashOf(text) {
      return 'hash' + text.split('').reduce((a,b) => ((a<<5)-a)+b.charCodeAt(0), 0);
    }
  </script>
</body>
</html>
