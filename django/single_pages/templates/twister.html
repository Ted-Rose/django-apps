<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twister!</title>
</head>
<body>
  <h1>Spēlējam Twister!</h1>
  <form id="base-array">
    <label for="query">Spelētāji</label>
    <input type="text" id="query" name="query" value="Kārlis">
    <button name="add_field">Pievienot lauku</button>
  </form>
  <div id="sub-arrays">
    <form id="sub-array-1">
      <label for="query">Dzīvnieku lauki</label>
      <input type="text" id="query" name="query" value="Lauva">
      <button name="add_field">Pievienot lauku</button>
    </form>
    <form id="sub-array-2">
      <label for="query">Krāsu lauki</label>
      <input type="text" id="query" name="query" value="Sarkanais lauciņš">
      <button name="add_field">Pievienot lauku</button>
    </form>
  </div>
  <button name="create_game">Spēlēt!</button>
  <input type="checkbox" id="Pause" name="Pause" value="Pauze">
  <script>
    moveLog = []


    // Create an audio player for message
    function createAudio(text, array, indexInArray) {
    filename = hashOf(text)
    fetch(`/text-to-audio?text=${encodeURIComponent(text)}&filename=${filename}`)
        .then(response => response.json())
        .then(data => {
            let audioPlayer = document.createElement({filename});
            audioPlayer.controls = true;
            audioPlayer.src = data.audio_url;
            document.querySelector(`#${array}-${indexInArray}`).appendChild(audioPlayer);
            array[indexInArray].push(filename: {filename})
        })
        .catch(error => console.error('Error fetching audio:', error));

    };


    function playAudios(stringArray){
      stringArray.forEach(string => {
        filename = hashOf(string)
        document.querySelector(`#${filename}`).play()
        // Freeze iteration until the audio is played
      })
    }


    function playGame(nextPlayer) {
      nextMove = [nextPlayer]
      subArrays.forEach(subArray, i => {
        nextMove.append(random(subArray))
      })

      playAudios(nextMove)

      // Wait until all move is played
      // Sleep for 5 seconds
      playNext = document.querySelector(`#Pause`).checked
      if playNext:
        playGame(indexOfNextPlayer + 1)
    }


    function createGame() {
      // Create JSON object containing arrays with single values - player name input value
      players = document.querySelectorAll('base-array')
      // At first create audios only for the first move to reduce audio creation latency
      async createAudio(players[0], 'base-array-0')
      moveLog[0].push(players[0])
      // Create JSON object containing JSON objects containing arrays with single values - move input value
      subArrays = document.querySelectorAll('sub-arrays')
      // At first create audios only for the first move to reduce audio creation latency
      subArrays.foreach(subArray, i => 
        move{i} = random(subArray)
        indexOfMoveInSubArray = ???
        async createAudio(move{i}, 'sub-array-{i}', indexOfMoveInSubArray)
        moveLog[0].append(move{i})
      )

      // Once first player and move audios are created play them async
      playAudios(moveLog[0])

      players.forEach(player, i => {
        hash = hashOf(player)
        createAudio(player, 'base-array', {i})
      })

      subArrays.forEach(subArray, i => {
        subArray.forEach(move, j => {
          hash = hashOf(move)
          createAudio(move, 'sub-array-{i}', {j})
        })
      })

      playGame(players[1])
    }
  </script>
</body>
</html>