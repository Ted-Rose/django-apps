<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twister!</title>
</head>
<body>
  <h1>Spēlējam Twister!</h1>
  <form id="base-array">
    <label for="base-query">Spelētāji</label>
    <input type="text" id="base-query" name="query" value="Kārlis">
    <button type="button" id="add_base_field">Pievienot lauku</button>
  </form>
  <div id="sub-arrays">
    <form id="sub-array-1">
      <label for="sub-query-1">Dzīvnieku lauki</label>
      <input type="text" id="sub-query-1" name="query" value="Lauva">
      <button type="button" id="add_sub_field_1">Pievienot lauku</button>
    </form>
    <form id="sub-array-2">
      <label for="sub-query-2">Krāsu lauki</label>
      <input type="text" id="sub-query-2" name="query" value="Sarkanais lauciņš">
      <button type="button" id="add_sub_field_2">Pievienot lauku</button>
    </form>
  </div>
  <button type="button" id="create_game">Spēlēt!</button>
  <input type="checkbox" id="Pause" name="Pause" value="Pauze">
  <script>
    let moveLog = [];

    function hashOf(text) {
      let hash = 0, i, chr;
      for (i = 0; i < text.length; i++) {
        chr = text.charCodeAt(i);
        hash = ((hash << 5) - hash) + chr;
        hash |= 0;
      }
      return 'hash' + hash;
    }

    // Create an audio player for message
    async function createAudio(text, array, indexInArray) {
      let filename = hashOf(text);
      try {
        let response = await fetch(`/text-to-audio?text=${encodeURIComponent(text)}&filename=${filename}`);
        if (!response.ok) throw new Error('Network response was not ok');
        let data = await response.json();
        let audioPlayer = document.createElement('audio');
        audioPlayer.controls = true;
        audioPlayer.src = data.audio_url;

        let targetElement = document.querySelector(`#${array}-${indexInArray}`);
        if (targetElement) {
          targetElement.appendChild(audioPlayer);
          array[indexInArray].push({ filename });
        } else {
          console.error(`Target element #${array}-${indexInArray} not found`);
        }
      } catch (error) {
        console.error('Error fetching audio:', error);
      }
    }

    function playAudios(stringArray) {
      stringArray.forEach(string => {
        let filename = hashOf(string);
        let audioElement = document.querySelector(`#${filename}`);
        if (audioElement) {
          audioElement.play().catch(error => console.error('Error playing audio:', error));
        } else {
          console.error(`Audio element #${filename} not found`);
        }
      });
    }

    function playGame(nextPlayer) {
      let nextMove = [nextPlayer];
      subArrays.forEach((subArray, i) => {
        nextMove.push(random(subArray));
      });

      playAudios(nextMove);

      setTimeout(() => {
        if (!document.querySelector('#Pause').checked) {
          playGame(indexOfNextPlayer + 1);
        }
      }, 5000);
    }

    function createGame() {
      let players = document.querySelectorAll('#base-array input');
      if (players.length === 0) {
        console.error('No players found');
        return;
      }

      let playerName = players[0].value;
      createAudio(playerName, 'base-array', 0);
      moveLog.push([playerName]);

      let subArrayForms = document.querySelectorAll('#sub-arrays form');
      subArrayForms.forEach((form, index) => {
        let subArrayName = form.querySelector('input').value;
        let indexInArray = index; // Assuming one value for simplicity
        createAudio(subArrayName, `sub-array-${index}`, indexInArray);
        moveLog[0].push(subArrayName);
      });

      playAudios(moveLog[0]);

      players.forEach((player, i) => {
        let hash = hashOf(player.value);
        createAudio(player.value, 'base-array', i);
      });

      subArrayForms.forEach((form, i) => {
        let subArrayInput = form.querySelectorAll('input');
        subArrayInput.forEach((move, j) => {
          let hash = hashOf(move.value);
          createAudio(move.value, `sub-array-${i}`, j);
        });
      });

      playGame(players[1].value);
    }

    document.querySelector('#create_game').addEventListener('click', createGame);
  </script>
</body>
</html>
